

jwt í† í° ìƒì„±ì‹œí‚¤ëŠ” í´ë”ì—ì„œ controller


public class LoginController {

   @Autowired
   private JwtProp jwtProp;
   
   /*
    ğŸ‘“ JWT ì„ ìƒì„±í•˜ëŠ” Login ìš”ì²­
    [POST] - /login
    body : 
      {
         "uid" : "user",
         "password" : "1234"
      }  
    */

   //ResponseEntity : HTTPì˜ ì‘ë‹µì„ ë‚˜íƒ€ë‚´ëŠ” í´ë˜ìŠ¤
   //AuthenticationRequest : domainì— ì •ì˜í•œ í´ë˜ìŠ¤
   @PostMapping("login")
   public ResponseEntity<?> login(@RequestBody AuthenticationRequest request) { 
       // /login ê²½ë¡œê°€ ì‹¤í–‰ë˜ë©´ AuthenticationRequestì— ì •ì˜ëœ uid, passwordë¡œ requestë¥¼ ë°›ëŠ”ë‹¤

       String uid = request.getUid();
       String password = request.getPassword();

       log.info("uid : " + uid);
       log.info("password : " + password);

      //ì‚¬ìš©ì ê¶Œí•œ
      List<String> roles = new ArrayList<>();
      roles.add("ROLE_USER");
      roles.add("ROLE_ADMIN");

      //ì‹œí¬ë¦¿í‚¤ -> ë°”ì´íŠ¸
      //ì‹œí¬ë¦¿í‚¤ë¥¼ ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•ŒëŠ” ë°”ì´íŠ¸ë¡œ ì‚¬ìš©ì„ í•œë‹¤
      String secretKey = jwtProp.getSecretKey();
      byte[] signingKey = jwtProp.getSecretKey().getBytes();

      //log.info("secretKey : " + secretKey);
      //log.info("signingKey : " + signingKey);

      //í† í° ìƒì„±
      String jwt = Jwts.builder()
                        //.signWith(ì‹œí¬ë¦¿í‚¤, ì•Œê³ ë¦¬ì¦˜)
                        .signWith(Keys.hmacShaKeyFor(signingKey), Jwts.SIG.HS512) //ì‹œê·¸ë‹ˆì²˜ì— ì‚¬ìš©í•  ë¹„ë°€í‚¤, ì•Œê³ ë¦¬ì¦˜ ì„¤ì •
                        .header()   //Header ì„¤ì •
                        .add("typ", SecurityConstants.TOKEN_TYPE) // "type" : "jwt"
                        .and()
                        .expiration(new Date(System.currentTimeMillis() + 1000 * 60 * 60*24*5)) //í† í° ë§Œë£Œ ì‹œê°„ 5ì¼ 1000(1ì´ˆ)*60(1ë¶„)*60(1ì‹œê°„)*24(í•˜ë£¨)*5(5ì¼)
                        .claim("uid", uid) //claim : í˜ì´ë¡œë“œì— ì €ì¥í•  ê°’
                        .claim("rol", roles) //claim : í˜ì´ë¡œë“œì— ì €ì¥í•  ê°’
                        .claim("mymake", "mymakeValue")
                        .claim("uid2", uid)
                        .compact();  //í† í° ìƒì„± ë©”ì†Œë“œ
      /*
         HEADER 
         {
            "typ": "jwt",
            "alg": "HS512"
         }
        
        PAYLOAD:DATA
        {
            "exp": 17293448,
            "uid": "use",
            "rol": [
               "ROLE_USER",
               "ROLE_ADMIN"
            ]
         }
       */
      log.info("jwt:"+jwt);

      return new ResponseEntity<String>(jwt, HttpStatus.OK);
   }

   //í† í° í•´ì„
   @GetMapping("/user/info")
   public ResponseEntity<?> userINfo(@RequestHeader(name="Authorization") String header) {
      //httpí—¤ë” ë¶€ë¶„ì˜ Authorizationì„ header ë³€ìˆ˜ì— ë‹´ëŠ”ë‹¤
      
      log.info("==========header==========");
      log.info("Authorization : " + header);

      //Authorization : Bearer : {jwt}
      //header.replace("Bearer ", "");
      String jwt = header.replace(SecurityConstants.TOKEN_PREFIX, "");
      /* String jwt = header.replace(" Bearer ", "==============="); */
      
      byte[] stringKey = jwtProp.getSecretKey().getBytes();

      log.info("/user/info jwt : " + jwt);

      //í† í° í•´ì„
      Jws<Claims> parsedTokens = Jwts.parser() //Jwtsì˜ parserë¥¼ í†µí•´ì„œ í† í°ì„ í•´ì„í•˜ê² ë‹¤
                                    .verifyWith(Keys.hmacShaKeyFor(stringKey)) //ì‹œí¬ë¦¿ í‚¤ë¥¼ ì•Œë ¤ì£¼ê³  
                                    .build()
                                    .parseSignedClaims(jwt); //í† í°ì„ ì£¼ê³  , parse:ë³€í™˜í•˜ê² ë‹¤, SignedClaims:ì•”í˜¸í™”ëœ Claimsë¥¼ 

      log.info("parsedTokens : " + parsedTokens);

      //username : user
      String uid = parsedTokens.getPayload().get("uid").toString();
      log.info("uid : " + uid);

      // rol : [ROLE_USER, ROLE_AMDIN]
      Claims claim = parsedTokens.getPayload();
      Object roles = claim.get("rol");
      log.info("roles : " + roles);

      return new ResponseEntity<String>(parsedTokens.toString(), HttpStatus.OK);
   }
   
}


